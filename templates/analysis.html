{% extends "base.html" %}
{% block content %}

<h2>Opportunities – Products vs Competitors</h2>
<p>
  This page shows each product with its basic factory cost (EXW + packing)
  and the best competitor price we have in the database.
</p>

{% if rows and rows|length > 0 %}
<table class="data-table">
  <thead>
    <tr>
      <th>Brand</th>
      <th>Model</th>
      <th>Size</th>
      <th>Segment</th>
      <th>Category</th>
      <th>Currency</th>
      <th>Factory Cost<br>(EXW + Packing)</th>
      <th>Best Competitor</th>
      <th>Region</th>
      <th>Best Price</th>
      <th>Profit / Tire</th>
      <th>Margin %</th>
      <th># Offers</th>
      <th>Stock</th>
    </tr>
  </thead>
  <tbody>
    {% for row in rows %}
      {% set p = row.product %}
      <tr>
        <td>{{ p.brand }}</td>
        <td>{{ p.model_name }}</td>
        <td>{{ p.size_string }}</td>
        <td>{{ p.segment }}</td>
        <td>{{ p.category }}</td>
        <td>{{ p.currency }}</td>
        <td>
          {% if row.factory_cost is not none %}
            {{ "%.2f"|format(row.factory_cost) }}
          {% else %}
            –
          {% endif %}
        </td>
        <td>
          {% if row.best_comp_name %}
            {{ row.best_comp_name }}
          {% else %}
            –
          {% endif %}
        </td>
        <td>{{ row.best_comp_region or "–" }}</td>
        <td>
          {% if row.best_price is not none %}
            {{ "%.2f"|format(row.best_price) }} {{ row.best_currency or "" }}
          {% else %}
            –
          {% endif %}
        </td>
        <td>
          {% if row.profit_per_tire is not none %}
            {{ "%.2f"|format(row.profit_per_tire) }}
          {% else %}
            –
          {% endif %}
        </td>
        <td>
          {% if row.margin_percent is not none %}
            {% set m = row.margin_percent %}
            <span
              class="
                margin-indicator
                {% if m < 5 %}margin-low{% elif m < 15 %}margin-mid{% else %}margin-high{% endif %}
              "
            >
              {{ "%.1f"|format(m) }}%
            </span>
          {% else %}
            –
          {% endif %}
        </td>
        <td>{{ row.offers_count }}</td>
        <td>
          {% if row.offers_count == 0 %}
            –
          {% else %}
            {% if row.any_in_stock %}In Stock{% else %}OOS / Unknown{% endif %}
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>No products or competitor offers yet. Add products and competitor prices first.</p>
{% endif %}

{% endblock %}
